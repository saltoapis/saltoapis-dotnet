
SHELL = /bin/bash

REPORTS_DIR ?= .reports

# Overridable by CI
COMMIT_SHORT     ?= $(shell git rev-parse --verify --short HEAD)
VERSION_NOPREFIX ?= "0.0.0-sha.$(COMMIT_SHORT)"
VERSION          ?= "v$(VERSION_NOPREFIX)"

.PHONY: prepare
prepare:
	# set auth
	dotnet nuget add source https://nuget.pkg.github.com/saltoapis/index.json -n github  -u $$GITHUB_ACTOR -p $$GITHUB_TOKEN  --store-password-in-clear-text
	# Encryption is not supported on non-Windows platforms.

	# create paket.dependencies file from Bazel metadata
	bazel build //:paket_dependencies
	cp -f "$(CURDIR)/bazel-bin/paket.dependencies" "$(CURDIR)/paket.dependencies"

	# and the required bazel files based on this paket.dependencies
	dotnet tool restore
	dotnet paket install
	bazel run @rules_dotnet//tools/paket2bazel:paket2bazel.exe --verbose_failures -- --dependencies-file $(CURDIR)/paket.dependencies --output-folder "$(CURDIR)"

.PHONY: sanity-check
sanity-check:

.PHONY: build
build:
	bazel build :build_autogenerated

.PHONY: test
test:
	bazel test --test_output=all //src/Saltoapis.Auth.Tests:all

.PHONY: release
release:
	# get all deploy rules and execute them
	bazel run :publish_all --define version=$(VERSION_NOPREFIX)

.PHONY: clean
clean:
	bazel clean
